# fscancer
This code was made available to reproduce the frameshift analysis in the publication:
"Frameshifts may carry oncogenic potential beyond loss of function"

## Components

### 1. Original Script
**File:** `combineCBIO.fs.pl`

Script should be run from the github clone of cBioPortal one level above public directory. No params needed, just redirect output to `cbio.fs.nocelllinepdx.txt`.

This is read by the Rmd script that generates the report used to analyze the data that was published.

### 2. Enhanced Script with Per-Sample Filtering
**File:** `combineCBIO.fs.filter.pl`

Enhanced version that supports metadata-based per-sample filtering. Useful when mutation files contain a mix of patient and model samples.

**Usage:**
```bash
# Basic usage with auto-discovery of metadata
perl combineCBIO.fs.filter.pl > output.txt

# With explicit metadata file
perl combineCBIO.fs.filter.pl --metadata /path/to/metadata.tsv > output.txt

# Verbose mode (shows filtering statistics on stderr)
perl combineCBIO.fs.filter.pl --verbose > output.txt

# Specify custom stats file location
perl combineCBIO.fs.filter.pl --stats my_stats.tsv > output.txt

# Include model samples (disable model filtering)
perl combineCBIO.fs.filter.pl --include-model > output.txt

# Include duplicate samples (disable duplicate filtering)
perl combineCBIO.fs.filter.pl --include-duplicates > output.txt
```

**Output Files:**
- Standard output: filtered mutation data
- `cnt`: gene counts (same as original script)
- `filter_stats.tsv`: per-project filtering statistics (customizable via `--stats`)

### 3. Sample Filter Module
**File:** `sample_filter.pl`

Perl module providing functions for metadata-based sample filtering and duplicate sample detection. Used by `combineCBIO.fs.filter.pl`.

## Filtering Statistics

The enhanced script generates a statistics file (`filter_stats.tsv` by default) with per-project breakdown:

```tsv
# Filtering Statistics Report
# Generated by combineCBIO.fs.filter.pl
#
project	rows_accepted	rows_rejected	rows_duplicate	samples_accepted	samples_rejected	samples_duplicate
study_center	150	25	10	45	8	3
another_study	200	0	5	60	0	2
#
# Summary
# Total projects processed: 2
# Total rows accepted: 350
# Total rows rejected (model): 25
# Total rows skipped (duplicate): 15
# Total unique samples accepted: 105
# Total unique samples rejected (model): 8
# Total unique samples skipped (duplicate): 5
```

**Columns:**
- `project`: Project/study name
- `rows_accepted`: Number of mutation rows kept (patient samples)
- `rows_rejected`: Number of mutation rows filtered out (model samples)
- `rows_duplicate`: Number of mutation rows skipped (duplicate samples from other projects)
- `samples_accepted`: Count of unique patient sample IDs
- `samples_rejected`: Count of unique model sample IDs filtered
- `samples_duplicate`: Count of unique sample IDs that were duplicates

## Duplicate Sample Detection

The enhanced script (`combineCBIO.fs.filter.pl`) automatically detects and removes duplicate samples that appear in multiple projects. This is particularly useful when combining data from overlapping studies.

**How it works:**
1. The script tracks all sample barcodes seen across projects
2. When a sample barcode is encountered again in a different project, those mutation rows are skipped
3. For TCGA samples, normalization is applied to handle variations in barcode format

**TCGA Barcode Handling:**
TCGA barcodes follow the format: `TCGA-XX-XXXX-XXX-XXX-XXXX-XX`
- The first 15 characters (`TCGA-XX-XXXX-XX`) identify the sample
- Samples with the same participant and sample type are considered duplicates

To include duplicate samples (disable duplicate filtering), use:
```bash
perl combineCBIO.fs.filter.pl --include-duplicates > output.txt
```

## Filtering Model Data

### Path-Based Filtering (Original Behavior)
Both scripts filter out model data based on study path names containing:
- `ccle` - Cancer Cell Line Encyclopedia
- `pdx` - Patient-Derived Xenograft models
- `cellline` or `cell_line` - Cell line studies
- `xenograft` - Xenograft models
- `test` - Test datasets

### Metadata-Based Per-Sample Filtering (New)
The enhanced script (`combineCBIO.fs.filter.pl`) supports per-sample filtering using metadata files. This is useful when a mutation file contains a mix of patient and model samples.

**How it works:**
1. The script auto-discovers metadata files in the current directory
2. Metadata files map sample barcodes to sample types
3. Mutation rows belonging to model samples are filtered out during merge

#### Supported Metadata Filenames
The script looks for these files (in order of priority):
- `metadata.tsv`
- `samples.tsv`
- `clinical_sample.tsv`
- `sample_metadata.csv`
- `sample_annotations.tsv`
- `clinical.tsv`
- Any file containing `sample`, `metadata`, or `clinical` in the name (`.tsv` or `.csv`)

#### Required Metadata Columns
The metadata file must have both:

**Sample ID Column** (one of, case-insensitive):
- `sample_id`
- `sample`
- `Tumor_Sample_Barcode`
- `sample_barcode`
- `sampleBarcode`

**Sample Type Column** (one of, case-insensitive):
- `sample_type`
- `sampleType`
- `sample_type_detail`
- `model`
- `is_model`
- `sample_class`

#### Model Sample Type Values
A sample is marked as a model if its type contains (case-insensitive):
- `pdx`
- `patient-derived xenograft`
- `xenograft`
- `cell line`, `cell_line`, or `cellline`
- `in vitro`
- `model`
- `ccle`

#### Example Metadata File
```tsv
sample_id	sample_type
SAMPLE001	Patient
SAMPLE002	PDX
SAMPLE003	Primary Tumor
SAMPLE004	Cell Line
SAMPLE005	Metastatic
```

## Running Tests
```bash
perl t/test_sample_filter.pl
```

## Backwards Compatibility
- The original `combineCBIO.fs.pl` script is unchanged
- The enhanced script maintains path-based filtering for compatibility
- If no metadata files are found, only path-based filtering is applied
- Mixed mutation files (with both patient and model samples) are now supported with per-sample filtering
